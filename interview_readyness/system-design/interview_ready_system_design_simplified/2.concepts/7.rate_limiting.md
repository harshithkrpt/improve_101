# Distributed Rate Limiting â€“ In-Depth Notes

---

## ğŸ“Œ What is Rate Limiting?

**Definition:**  
Rate limiting is a strategy to limit the number of requests a system will accept and process over a period of time.

**Purpose:**  
- Prevent system overload and crashes  
- Avoid Out of Memory errors  
- Improve user experience  
- Mitigate cascading failures (where one service's failure causes others to fail)

**Example of Cascading Failure:**  
- Server A and B both support 500 requests  
- B receives 600 â†’ crashes â†’ A receives overflow â†’ A crashes  
- Proper rate limiting avoids this

---

## ğŸ›  Short-Term Solutions

1. **Vertical Scaling**  
   - Increase system capacity  
   - Expensive

2. **Efficient Messaging (gRPC)**  
   - Avoids head-of-line blocking via multiplexing  
   - Asynchronous processing

3. **Message Compression**  
   - Smaller messages = faster processing

4. **Persistent Connections**  
   - Reduce overhead from opening/closing connections

5. **Push/Pull Hybrid**  
   - Push response expensive â†’ allow clients to pull instead

6. **Graceful Degradation**  
   - Drop non-critical features during high load

---

## ğŸ§© System Design for Rate Limiting

### ğŸ”® Oracle

- **Function:** Decides if a request should be processed  
- **How:** Services register and provide their capacity  
- **Interaction:** Gateway â†’ Oracle â†’ Decision

### ğŸšª Gateway Service

- Asks oracle if request is allowed  
- Routes allowed requests or returns 503 otherwise

---

## ğŸ§® Rate Limiting Algorithms

### 1. Sliding Window

- Allows N requests in fixed time window  
- **Pros:** Simple to implement  
- **Cons:**  
  - High memory (stores N requests)  
  - Requires garbage collection to clean old requests

### 2. Timer Wheel

- **Buckets:** Timeout-sized wheel (e.g., 60s â†’ 60 buckets)  
- **Insertion:** request â†’ `Time % bucket_count`  
- **Each bucket:** Holds requests for that second  
- **Before insert:** clean old unprocessed requests

#### Hierarchical Timer Wheel
- Used to reduce distance between requests when many buckets waste memory/time

---

## ğŸ§± Internal Rate Limiting (Service-to-Service)

### Service Load Indicators

1. **Average Response Time**  
   - Higher = under load

2. **Age of Requests**  
   - If waiting > processing time â†’ overload

3. **Dead Letter Queue (DLQ)**  
   - Increased messages in DLQ = system can't process requests

---

## ğŸ§® Queue Partitioning Strategy

- **Problem:** One bad request blocks queue  
- **Solution:** Partition queue into `x` parts  
  - Use `hash(request_id) % x` to assign queue  
  - Reduces request blockage impact

- **Advanced:**  
  - More queues  
  - Larger queues  
  - Further partition overloaded ones (nested hash)

---

## âš¡ Real Life Optimizations

### Request Collapsing

- If many clients request same data â†’ collapse into one request â†’ cache response for all

### Client-Side Rate Limiting

- **Error Handling:**  
  - Permanent: Donâ€™t retry  
  - Temporary: Retry using Exponential Backoff

#### ğŸ” Exponential Backoff

- Wait time grows exponentially before retry  
- Stops after max retries

---

## ğŸ“ Capacity Estimation

**Assumptions:**  
- Services: 100  
- APIs/service: 30  
- Timeout/API: 60s  
- Req size: 1 KB  
- 10 req/sec per API

### Oracle Memory Calculation

- **Total API requests/sec:** 30 * 10 * 100 = 30,000  
- **Each ID = 8 bytes**  
- Memory/sec = 8 * 30,000 = 240 KB  
- 60 buckets â†’ total = 240 * 60 = 14.4 MB (~15 MB)

---

## â³ Maximum Queue Wait Time

**Assumptions:**  
- Timeout: 10s  
- Travel time: 100ms (each way)  
- Processing time: 1s

`= 10 - 0.2 - 1 = 8.8s`

---

## ğŸ§® Maximum Queue Size

**Assumptions:**  
- Requests/sec = 1000  
- Req size = 1 KB  
- Data/sec = 1 MB  
- Wait time = 8.8s

`= 1 MB * 8.8s = 8.8 MB`

---

## ğŸ“š Summary

- Prevent overload using rate limiting
- Use sliding windows or timer wheels
- Monitor service health via response time, request age, DLQs
- Use partitioning and retries wisely
- Estimate memory and queue sizes precisely

---

_Source: [InterviewReady.io](https://get.interviewready.io/)_